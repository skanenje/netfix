{% extends 'main/base.html' %}

{% block content %}
<div class="registration-page">
<div class="register-container">
    <div class="register-header">
        <div class="logo">
            <div class="logo-icon">N</div>
            <span>NetFix</span>
        </div>
        <h1 class="register-title">Create Your Account</h1>
        <p class="register-subtitle">Join our community</p>
    </div>

    <form class="register-form" method="post" id="registerForm">
        {% csrf_token %}
        <input type="hidden" name="user_type" id="userType" value="customer">

        <!-- User Type Toggle Buttons -->
        <div class="user-type-toggle">
            <button type="button" class="toggle-btn active" onclick="showForm('customer')">
                <span>üë§ Customer</span>
            </button>
            <button type="button" class="toggle-btn" onclick="showForm('company')">
                <span>üè¢ Company</span>
            </button>
        </div>

        <div id="customerFields" class="form-fields">
            <div class="form-group">
                <label>Email</label>
                {{ customer_form.email }}
                {% if customer_form.email.errors %}
                    <div class="error-message">{{ customer_form.email.errors.0 }}</div>
                {% endif %}
            </div>
            <div class="form-group">
                <label>Username</label>
                {{ customer_form.username }}
                {% if customer_form.username.errors %}
                    <div class="error-message">{{ customer_form.username.errors.0 }}</div>
                {% endif %}
            </div>
            <div class="form-group">
                <label>Date of Birth</label>
                {{ customer_form.date_of_birth }}
                {% if customer_form.date_of_birth.errors %}
                    <div class="error-message">{{ customer_form.date_of_birth.errors.0 }}</div>
                {% endif %}
            </div>
            <div class="form-group">
                <label>Password</label>
                {{ customer_form.password1 }}
                {% if customer_form.password1.errors %}
                    <div class="error-message">{{ customer_form.password1.errors.0 }}</div>
                {% endif %}
            </div>
            <div class="form-group">
                <label>Confirm Password</label>
                {{ customer_form.password2 }}
                {% if customer_form.password2.errors %}
                    <div class="error-message">{{ customer_form.password2.errors.0 }}</div>
                {% endif %}
            </div>
        </div>

        <div id="companyFields" class="form-fields" style="display: none;">
            <div class="form-group">
                <label>Email</label>
                {{ company_form.email }}
                {% if company_form.email.errors %}
                    <div class="error-message">{{ company_form.email.errors.0 }}</div>
                {% endif %}
            </div>
            <div class="form-group">
                <label>Username</label>
                {{ company_form.username }}
                {% if company_form.username.errors %}
                    <div class="error-message">{{ company_form.username.errors.0 }}</div>
                {% endif %}
            </div>
            <div class="form-group">
                <label>Field of Work</label>
                {{ company_form.field }}
                {% if company_form.field.errors %}
                    <div class="error-message">{{ company_form.field.errors.0 }}</div>
                {% endif %}
            </div>
            <div class="form-group">
                <label>Password</label>
                {{ company_form.password1 }}
                {% if company_form.password1.errors %}
                    <div class="error-message">{{ company_form.password1.errors.0 }}</div>
                {% endif %}
            </div>
            <div class="form-group">
                <label>Confirm Password</label>
                {{ company_form.password2 }}
                {% if company_form.password2.errors %}
                    <div class="error-message">{{ company_form.password2.errors.0 }}</div>
                {% endif %}
            </div>
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">Create Account</button>

        <div class="login-link">
            Already have an account? <a href="{% url 'users:login_user' %}">Sign in here</a>
        </div>
    </form>
</div>
</div>

<script>
    function showForm(type) {
        document.getElementById('userType').value = type;
        document.getElementById('customerFields').style.display = type === 'customer' ? 'block' : 'none';
        document.getElementById('companyFields').style.display = type === 'company' ? 'block' : 'none';
        document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }

    // Form validation
    function validateForm(formType) {
        let isValid = true;
        const errors = {};
        
        // Common validations for both forms
        const email = document.querySelector(`#${formType}_form-email`).value.trim();
        const username = document.querySelector(`#${formType}_form-username`).value.trim();
        const password1 = document.querySelector(`#${formType}_form-password1`).value;
        const password2 = document.querySelector(`#${formType}_form-password2`).value;
        
        // Clear previous error messages
        document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
        
        // Email validation
        if (!email) {
            errors.email = 'Email is required';
            isValid = false;
        } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            errors.email = 'Please enter a valid email address';
            isValid = false;
        }
        
        // Username validation
        if (!username) {
            errors.username = 'Username is required';
            isValid = false;
        } else if (username.length < 3) {
            errors.username = 'Username must be at least 3 characters long';
            isValid = false;
        }
        
        // Password validation
        if (!password1) {
            errors.password1 = 'Password is required';
            isValid = false;
        } else if (password1.length < 8) {
            errors.password1 = 'Password must be at least 8 characters long';
            isValid = false;
        } else if (!/(?=.*[A-Z])(?=.*[a-z])(?=.*\d)(?=.*[^A-Za-z0-9])/.test(password1)) {
            errors.password1 = 'Password must contain at least one uppercase letter, one lowercase letter, one number and one special character';
            isValid = false;
        }
        
        // Confirm password
        if (password1 !== password2) {
            errors.password2 = 'Passwords do not match';
            isValid = false;
        }
        
        // Form specific validations
        if (formType === 'customer') {
            const dob = document.querySelector('#customer_form-date_of_birth').value;
            if (!dob) {
                errors.date_of_birth = 'Date of birth is required';
                isValid = false;
            } else {
                const birthDate = new Date(dob);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                
                if (age < 13) {
                    errors.date_of_birth = 'You must be at least 13 years old to register';
                    isValid = false;
                }
            }
        } else if (formType === 'company') {
            const field = document.querySelector('#company_form-field').value;
            if (!field) {
                errors.field = 'Field of work is required';
                isValid = false;
            }
        }
        
        // Display errors if any
        Object.keys(errors).forEach(field => {
            const errorElement = document.querySelector(`#${formType}_form-${field}`).parentNode.querySelector('.error-message');
            if (errorElement) {
                errorElement.textContent = errors[field];
            }
        });
        
        return isValid;
    }

    // Form submission with validation and AJAX
    document.getElementById('registerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const userType = document.getElementById('userType').value;
        if (!validateForm(userType)) {
            return; // Stop form submission if validation fails
        }
        
        const formData = new FormData(this);
        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = data.redirect;
            } else {
                // Display errors (simplified - add to DOM as needed)
                console.error('Errors:', data.errors);
                // Example: Show errors in UI
                Object.entries(data.errors).forEach(([field, error]) => {
                    const errorDiv = document.querySelector(`[name="${field}"]`).nextElementSibling;
                    if (errorDiv && errorDiv.classList.contains('error-message')) {
                        errorDiv.textContent = error[0];
                        errorDiv.classList.add('show');
                    }
                });
            }
        })
        .catch(error => console.error('Error:', error));
    });

    // Add real-time validation as in your original (password, email) - omitted for brevity, but keep if needed
</script>
{% endblock %}
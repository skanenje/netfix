{% extends 'main/base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/registration.css' %}">
<div class="registration-page">
<div class="register-container">
    <div class="register-header">
        <div class="logo">
            <div class="logo-icon">N</div>
            <span>NetFix</span>
        </div>
        <h1 class="register-title">Create Your Account</h1>
        <p class="register-subtitle">Join our community</p>
    </div>

    <form class="register-form" method="post" id="registerForm" novalidate>
        {% csrf_token %}
        <input type="hidden" name="user_type" id="userType" value="customer">

        <!-- User Type Toggle Buttons -->
        <div class="user-type-toggle">
            <button type="button" class="toggle-btn active" onclick="showForm('customer', this)">
                <span>üë§ Customer</span>
            </button>
            <button type="button" class="toggle-btn" onclick="showForm('company', this)">
                <span>üè¢ Company</span>
            </button>
        </div>

        <div id="customerFields" class="form-fields">
            <div class="form-group">
                <label>Email</label>
                {{ customer_form.email }}
                {% if customer_form.email.errors %}
                    <div class="error-message">{{ customer_form.email.errors.0 }}</div>
                {% endif %}
            </div>
            <div class="form-group">
                <label>Username</label>
                {{ customer_form.username }}
                {% if customer_form.username.errors %}
                    <div class="error-message">{{ customer_form.username.errors.0 }}</div>
                {% endif %}
            </div>
            <div class="form-group">
                <label>Date of Birth</label>
                {{ customer_form.date_of_birth }}
                {% if customer_form.date_of_birth.errors %}
                    <div class="error-message">{{ customer_form.date_of_birth.errors.0 }}</div>
                {% endif %}
            </div>
            <div class="form-group">
                <label>Password</label>
                {{ customer_form.password1 }}
                {% if customer_form.password1.errors %}
                    <div class="error-message">{{ customer_form.password1.errors.0 }}</div>
                {% endif %}
            </div>
            <div class="form-group">
                <label>Confirm Password</label>
                {{ customer_form.password2 }}
                {% if customer_form.password2.errors %}
                    <div class="error-message">{{ customer_form.password2.errors.0 }}</div>
                {% endif %}
            </div>
        </div>

        <div id="companyFields" class="form-fields" style="display: none;">
            <div class="form-group">
                <label>Email</label>
                {{ company_form.email }}
                {% if company_form.email.errors %}
                    <div class="error-message">{{ company_form.email.errors.0 }}</div>
                {% endif %}
            </div>
            <div class="form-group">
                <label>Username</label>
                {{ company_form.username }}
                {% if company_form.username.errors %}
                    <div class="error-message">{{ company_form.username.errors.0 }}</div>
                {% endif %}
            </div>
            <div class="form-group">
                <label>Field of Work</label>
                {{ company_form.field }}
                {% if company_form.field.errors %}
                    <div class="error-message">{{ company_form.field.errors.0 }}</div>
                {% endif %}
            </div>
            <div class="form-group">
                <label>Password</label>
                {{ company_form.password1 }}
                {% if company_form.password1.errors %}
                    <div class="error-message">{{ company_form.password1.errors.0 }}</div>
                {% endif %}
            </div>
            <div class="form-group">
                <label>Confirm Password</label>
                {{ company_form.password2 }}
                {% if company_form.password2.errors %}
                    <div class="error-message">{{ company_form.password2.errors.0 }}</div>
                {% endif %}
            </div>
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">Create Account</button>

        <div class="login-link">
            Already have an account? <a href="{% url 'users:login_user' %}">Sign in here</a>
        </div>
    </form>
</div>
</div>

<script>
    // Global variables
    let currentFormType = 'customer';

    function showForm(type, clickedElement) {
        try {
            currentFormType = type;
            document.getElementById('userType').value = type;
            
            const customerFields = document.getElementById('customerFields');
            const companyFields = document.getElementById('companyFields');
            
            if (type === 'customer') {
                customerFields.style.display = 'block';
                companyFields.style.display = 'none';
                
                // Enable customer form fields and disable company form fields
                customerFields.querySelectorAll('input, select').forEach(field => {
                    field.disabled = false;
                    field.removeAttribute('disabled');
                });
                companyFields.querySelectorAll('input, select').forEach(field => {
                    field.disabled = true;
                    field.setAttribute('disabled', 'disabled');
                });
            } else {
                customerFields.style.display = 'none';
                companyFields.style.display = 'block';
                
                // Enable company form fields and disable customer form fields
                companyFields.querySelectorAll('input, select').forEach(field => {
                    field.disabled = false;
                    field.removeAttribute('disabled');
                });
                customerFields.querySelectorAll('input, select').forEach(field => {
                    field.disabled = true;
                    field.setAttribute('disabled', 'disabled');
                });
            }
            
            // Remove active class from all buttons
            document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            
            // Add active class to the clicked button
            if (clickedElement) {
                // Find the button element (could be the span inside)
                let buttonElement = clickedElement;
                if (clickedElement.tagName === 'SPAN') {
                    buttonElement = clickedElement.parentElement;
                }
                if (buttonElement && buttonElement.classList.contains('toggle-btn')) {
                    buttonElement.classList.add('active');
                }
            }
        } catch (error) {
            console.error('Error in showForm:', error);
        }
    }

    // Form validation
    function validateForm(formType) {
        let isValid = true;
        const errors = {};
        
        try {
            // Get active form fields only
            const activeContainer = formType === 'customer' ? 
                document.getElementById('customerFields') : 
                document.getElementById('companyFields');
            
            const emailField = activeContainer.querySelector('input[name="email"]');
            const usernameField = activeContainer.querySelector('input[name="username"]');
            const password1Field = activeContainer.querySelector('input[name="password1"]');
            const password2Field = activeContainer.querySelector('input[name="password2"]');
            
            // Check if fields exist and get values
            const email = emailField ? emailField.value.trim() : '';
            const username = usernameField ? usernameField.value.trim() : '';
            const password1 = password1Field ? password1Field.value : '';
            const password2 = password2Field ? password2Field.value : '';
            
            // Clear previous error messages
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
            
            // Email validation
            if (!email) {
                errors.email = 'Email is required';
                isValid = false;
            } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                errors.email = 'Please enter a valid email address';
                isValid = false;
            }
            
            // Username validation
            if (!username) {
                errors.username = 'Username is required';
                isValid = false;
            } else if (username.length < 3) {
                errors.username = 'Username must be at least 3 characters long';
                isValid = false;
            }
            
            // Password validation
            if (!password1) {
                errors.password1 = 'Password is required';
                isValid = false;
            } else if (password1.length < 8) {
                errors.password1 = 'Password must be at least 8 characters long';
                isValid = false;
            }
            
            // Confirm password
            if (password1 !== password2) {
                errors.password2 = 'Passwords do not match';
                isValid = false;
            }
            
            // Form specific validations
            if (formType === 'customer') {
                const dobField = activeContainer.querySelector('input[name="date_of_birth"]');
                const dob = dobField ? dobField.value : '';
                if (!dob) {
                    errors.date_of_birth = 'Date of birth is required';
                    isValid = false;
                }
            } else if (formType === 'company') {
                const fieldField = activeContainer.querySelector('select[name="field"]');
                const field = fieldField ? fieldField.value : '';
                if (!field) {
                    errors.field = 'Field of work is required';
                    isValid = false;
                }
            }
            
            // Display errors if any
            Object.keys(errors).forEach(field => {
                const fieldElement = activeContainer.querySelector(`input[name="${field}"], select[name="${field}"]`);
                if (fieldElement) {
                    const errorElement = fieldElement.parentNode.querySelector('.error-message');
                    if (errorElement) {
                        errorElement.textContent = errors[field];
                    }
                }
            });
            
        } catch (error) {
            console.error('Error in validateForm:', error);
            isValid = false;
        }
        
        return isValid;
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        try {
            // Set up form submission handler
            const form = document.getElementById('registerForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const userType = document.getElementById('userType').value;
                    if (!validateForm(userType)) {
                        return;
                    }
                    
                    const formData = new FormData(this);
                    fetch(window.location.href, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.href = data.redirect;
                        } else {
                            console.error('Errors:', data.errors);
                            // Display server errors
                            Object.entries(data.errors).forEach(([field, error]) => {
                                const fieldElement = document.querySelector(`input[name="${field}"], select[name="${field}"]`);
                                if (fieldElement && !fieldElement.disabled) {
                                    const errorElement = fieldElement.parentNode.querySelector('.error-message');
                                    if (errorElement) {
                                        errorElement.textContent = Array.isArray(error) ? error[0] : error;
                                    }
                                }
                            });
                        }
                    })
                    .catch(error => console.error('Error:', error));
                });
            }
            
            // Initialize with customer form
            showForm('customer', document.querySelector('.toggle-btn.active'));
            
        } catch (error) {
            console.error('Error during initialization:', error);
        }
    });
</script>
{% endblock %}